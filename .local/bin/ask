#! /bin/python
import requests,json,sys,os

query=""
if not sys.stdin.isatty():
    query = sys.stdin.read()
if len(sys.argv) >1:
    query = " ".join(sys.argv[1:]) + "\n" + query

message =[{'role': 'user', 'content': query}]

data = {
    "messages": message,
    "model": "gpt-3.5-turbo",
    "temperature": 0.3,
    "top_p": 1,
    "stream": True
}
response = requests.post(
  "https://api.openai.com/v1/chat/completions",
  headers = {
    "Content-Type": "application/json",
    "Authorization": os.environ["CHATGPTTOKEN"],
  },
  json=data,
  stream=True,
  timeout=60
)
response.raise_for_status()
total=""
for line in response.iter_lines():
  data = line.lstrip(b"data: ").decode("utf-8")
  if data == "[DONE]":  # type: ignore
      break
  if not data:
      continue
  data = json.loads(data)  # type: ignore
  delta = data["choices"][0]["delta"]  # type: ignore
  if "content" not in delta:
      continue
  print(delta["content"],end="")
  total+=delta["content"]
print()
with open("/home/dex/.cache/gpt/.querylog","w") as f:
    f.write(query)
with open("/home/dex/.cache/gpt/log","w") as f:
    f.write(total)
os.system("notify-send done")
